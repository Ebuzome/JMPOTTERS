<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product | JMPOTTERS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Ultra-precise custom styles */
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-surface: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --success: #10b981;
            --error: #ef4444;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container-tight {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        @media (min-width: 640px) { .container-tight { padding: 0 1.5rem; } }
        @media (min-width: 1024px) { .container-tight { padding: 0 2rem; } }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            html { font-size: 14px; }
            .mobile-stack { flex-direction: column; gap: 1rem; }
            .mobile-padding-tight { padding: 0.5rem; }
        }

        @media (max-width: 480px) {
            html { font-size: 13px; }
            .mobile-padding-tighter { padding: 0.25rem; }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-surface); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }

        /* Notification */
        .notification {
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-gray-900 border-b border-gray-800">
        <div class="container-tight">
            <div class="flex items-center justify-between h-16">
                <button onclick="history.back()" class="flex items-center gap-2 text-gray-300 hover:text-white">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hidden sm:inline">Back</span>
                </button>

                <a href="index.html" class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-amber-700 rounded-lg flex items-center justify-center">
                        <i class="fas fa-gem text-white text-sm"></i>
                    </div>
                    <span class="text-xl font-bold text-white">JMPOTTERS</span>
                </a>

                <div class="flex items-center gap-3">
                    <button id="wishlistBtn" class="relative p-2 text-gray-300 hover:text-red-400">
                        <i class="far fa-heart text-xl"></i>
                        <span id="wishlistCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>

                    <button id="cartBtn" class="relative p-2 text-gray-300 hover:text-amber-400">
                        <i class="fas fa-shopping-bag text-xl"></i>
                        <span id="cartCount" class="absolute -top-1 -right-1 bg-amber-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-tight py-4 md:py-6">
        <!-- Loading State -->
        <div id="loadingState" class="min-h-[60vh] flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500 mb-4"></div>
            <p class="text-gray-400">Loading product details...</p>
        </div>

        <!-- Product Content -->
        <div id="productContent" class="hidden">
            <nav class="mb-4 text-sm text-gray-400">
                <div class="flex items-center gap-2">
                    <a href="index.html" class="hover:text-amber-400">Home</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span id="categoryBreadcrumb" class="hover:text-amber-400 cursor-pointer">Category</span>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span id="productBreadcrumb" class="text-gray-300">Product</span>
                </div>
            </nav>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                <!-- Left Column - Image -->
                <div class="space-y-4">
                    <div class="bg-gray-800 rounded-xl p-4">
                        <img id="mainImage" 
                             src="" 
                             alt="Product Image"
                             class="w-full h-auto object-contain rounded-lg"
                             onerror="this.src='https://via.placeholder.com/600x600/1e293b/94a3b8?text=JMPOTTERS'">
                    </div>
                    <p class="text-center text-sm text-gray-500">
                        <i class="fas fa-search-plus mr-2"></i>Click image to view larger
                    </p>
                </div>

                <!-- Right Column - Details -->
                <div class="space-y-6">
                    <h1 id="productTitle" class="text-2xl md:text-3xl font-bold text-white"></h1>

                    <div class="flex items-baseline gap-3">
                        <span id="currentPrice" class="text-3xl font-bold text-white"></span>
                        <span id="originalPrice" class="text-xl text-gray-400 line-through"></span>
                        <span class="px-2 py-1 bg-red-900/30 text-red-300 text-sm font-semibold rounded">
                            35% OFF
                        </span>
                    </div>

                    <div class="p-3 bg-green-900/20 border border-green-800/30 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-400"></i>
                            <span class="text-green-300 font-medium">In Stock</span>
                            <span id="stockCount" class="text-green-400/80 text-sm ml-auto">Ready to ship</span>
                        </div>
                    </div>

                    <!-- Variant Selectors -->
                    <div id="variantSelectors" class="space-y-4">
                        <!-- Color Selector -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">COLOR</label>
                            <div class="flex flex-wrap gap-2">
                                <div id="colorOptions">
                                    <!-- Color options will be added here -->
                                </div>
                            </div>
                        </div>

                        <!-- Size Selector -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">SIZE</label>
                            <div class="flex flex-wrap gap-2">
                                <div id="sizeOptions">
                                    <!-- Size options will be added here -->
                                </div>
                            </div>
                        </div>

                        <!-- Selection Summary -->
                        <div id="selectionSummary" class="hidden p-3 bg-amber-900/10 border border-amber-800/20 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-amber-300">Selected:</p>
                                    <p id="selectedVariantText" class="font-medium text-white"></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-amber-300">Stock:</p>
                                    <p id="availableStockText" class="text-lg font-bold text-white">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">QUANTITY</label>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center border border-gray-700 rounded-lg overflow-hidden">
                                <button id="decreaseQty" class="px-4 py-2 bg-gray-800 hover:bg-gray-700">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input id="quantityInput" type="number" value="1" min="1" max="100" 
                                       class="w-16 text-center bg-transparent border-0 focus:ring-0">
                                <button id="increaseQty" class="px-4 py-2 bg-gray-800 hover:bg-gray-700">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button data-qty="1" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">1</button>
                                <button data-qty="5" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">5</button>
                                <button data-qty="10" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">10</button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button id="addToCartBtn" class="w-full py-3 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-shopping-cart"></i>
                            ADD TO CART
                        </button>
                        
                        <a id="whatsappBtn" href="#" target="_blank" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg flex items-center justify-center gap-2">
                            <i class="fab fa-whatsapp"></i>
                            BUY NOW
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden min-h-[60vh] flex flex-col items-center justify-center text-center">
            <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">Product Not Found</h2>
            <p class="text-gray-400 mb-6 max-w-md" id="errorMessage"></p>
            <a href="index.html" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg">
                RETURN TO HOMEPAGE
            </a>
        </div>
    </main>

    <!-- Cart Panel -->
    <div id="cartPanel" class="fixed inset-y-0 right-0 w-full md:w-96 bg-gray-900 border-l border-gray-800 transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b border-gray-800">
                <h3 class="text-lg font-bold text-white">CART</h3>
                <button id="closeCartBtn" class="p-2 text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="cartItems" class="flex-1 overflow-y-auto p-4">
                <div id="emptyCart" class="text-center py-12">
                    <i class="fas fa-shopping-bag text-gray-600 text-3xl mb-4"></i>
                    <p class="text-gray-400">Your cart is empty</p>
                </div>
            </div>
            
            <div class="border-t border-gray-800 p-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-300">Total:</span>
                    <span id="cartTotal" class="text-xl font-bold text-white">₦0</span>
                </div>
                <a id="whatsappCheckout" href="#" target="_blank" class="block w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg text-center">
                    CHECKOUT ON WHATSAPP
                </a>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 z-50 max-w-sm"></div>

    <script>
        // Global state
        const state = {
            product: null,
            colors: [],
            sizes: [],
            selectedColor: null,
            selectedSize: null,
            quantity: 1,
            cart: JSON.parse(localStorage.getItem('jmpotters_cart')) || [],
            wishlist: JSON.parse(localStorage.getItem('jmpotters_wishlist')) || []
        };

        // Supabase configuration
        const SUPABASE_URL = 'https://tmpggeeuwdvlngvfncaa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcGdnZWV1d2R2bG5ndmZuY2FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTc0MDYsImV4cCI6MjA3Nzc3MzQwNn0.EKzkKWmzYMvQuN11vEjRTDHrUbh6dYXk7clxVsYQ0b4';

        // Category slug mapping
        const CATEGORY_MAP = {
            1: 'mensfootwear',
            2: 'womensfootwear',
            3: 'bags',
            4: 'household',
            5: 'healthcare',
            6: 'accessories',
            10: 'kids'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        async function initApp() {
            // Initialize UI
            setupUI();
            
            // Load product
            await loadProduct();
            
            // Update counts
            updateHeaderCounts();
        }

        function setupUI() {
            // Cart panel
            const cartBtn = document.getElementById('cartBtn');
            const closeCartBtn = document.getElementById('closeCartBtn');
            const overlay = document.getElementById('overlay');

            cartBtn.addEventListener('click', openCart);
            closeCartBtn.addEventListener('click', closeCart);
            overlay.addEventListener('click', closeCart);

            // Wishlist button
            document.getElementById('wishlistBtn').addEventListener('click', () => {
                if (state.product) toggleWishlist(state.product);
            });

            // Quantity controls
            const quantityInput = document.getElementById('quantityInput');
            const decreaseBtn = document.getElementById('decreaseQty');
            const increaseBtn = document.getElementById('increaseQty');
            const bulkBtns = document.querySelectorAll('[data-qty]');

            decreaseBtn.addEventListener('click', () => {
                if (state.quantity > 1) {
                    state.quantity--;
                    quantityInput.value = state.quantity;
                }
            });

            increaseBtn.addEventListener('click', () => {
                const maxStock = state.selectedSize?.stock || state.product?.stock || 100;
                if (state.quantity < maxStock) {
                    state.quantity++;
                    quantityInput.value = state.quantity;
                }
            });

            quantityInput.addEventListener('change', () => {
                const value = parseInt(quantityInput.value) || 1;
                const maxStock = state.selectedSize?.stock || state.product?.stock || 100;
                state.quantity = Math.max(1, Math.min(value, maxStock));
                quantityInput.value = state.quantity;
            });

            bulkBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const qty = parseInt(this.dataset.qty);
                    const maxStock = state.selectedSize?.stock || state.product?.stock || 100;
                    state.quantity = Math.min(qty, maxStock);
                    quantityInput.value = state.quantity;
                });
            });

            // Add to cart button
            document.getElementById('addToCartBtn').addEventListener('click', addToCart);

            // Category breadcrumb click
            document.getElementById('categoryBreadcrumb').addEventListener('click', function() {
                if (state.product?.category_slug) {
                    window.location.href = `${state.product.category_slug}.html`;
                }
            });
        }

        async function loadProduct() {
            try {
                // Get slug from URL
                const urlParams = new URLSearchParams(window.location.search);
                const slug = urlParams.get('slug');
                
                if (!slug) {
                    throw new Error('No product specified in URL');
                }

                console.log('Loading product with slug:', slug);

                // Create Supabase client
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // Fetch product by slug
                const { data: product, error: productError } = await supabase
                    .from('products')
                    .select('*')
                    .eq('slug', slug)
                    .eq('is_active', true)
                    .single();

                if (productError) {
                    console.error('Product fetch error:', productError);
                    throw new Error('Product not found in database');
                }

                if (!product) {
                    throw new Error('Product not found');
                }

                console.log('Product found:', product);

                // Get category info
                let categorySlug = 'mensfootwear';
                let categoryName = 'Category';
                
                if (product.category_id && CATEGORY_MAP[product.category_id]) {
                    categorySlug = CATEGORY_MAP[product.category_id];
                    categoryName = categorySlug.charAt(0).toUpperCase() + categorySlug.slice(1);
                }

                // Fetch colors
                const { data: colors, error: colorsError } = await supabase
                    .from('product_colors')
                    .select('*')
                    .eq('product_id', product.id);

                if (colorsError) {
                    console.warn('Colors fetch error:', colorsError);
                }

                // Fetch sizes
                const { data: sizes, error: sizesError } = await supabase
                    .from('product_sizes')
                    .select('*')
                    .eq('product_id', product.id);

                if (sizesError) {
                    console.warn('Sizes fetch error:', sizesError);
                }

                // Update state
                state.product = {
                    ...product,
                    category_slug: categorySlug,
                    category_name: categoryName
                };
                state.colors = colors || [];
                state.sizes = sizes || [];

                // Render product
                renderProduct();

                // Hide loading, show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('productContent').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading product:', error);
                showError(error.message || 'Failed to load product. Please check the URL and try again.');
            }
        }

        function renderProduct() {
            if (!state.product) return;

            const product = state.product;
            const categorySlug = product.category_slug || 'mensfootwear';
            const imageUrl = `https://ebuzome.github.io/JMPOTTERS/assets/images/${categorySlug}/${product.image_url}`;
            const fakePrice = product.price ? Math.round(product.price * 1.35) : 0;
            const isFootwear = ['mensfootwear', 'womensfootwear'].includes(categorySlug);

            // Set basic info
            document.title = `${product.name} | JMPOTTERS`;
            document.getElementById('productTitle').textContent = product.name;
            document.getElementById('productBreadcrumb').textContent = product.name;
            document.getElementById('categoryBreadcrumb').textContent = product.category_name;

            // Set image
            const mainImage = document.getElementById('mainImage');
            mainImage.src = imageUrl;
            mainImage.alt = product.name;

            // Set prices
            document.getElementById('currentPrice').textContent = formatPrice(product.price);
            document.getElementById('originalPrice').textContent = formatPrice(fakePrice);

            // Set stock
            document.getElementById('stockCount').textContent = `${product.stock || 100} units available`;

            // Render variant selectors if footwear
            if (isFootwear && state.colors.length > 0) {
                renderColorOptions();
                renderSizeOptions();
                document.getElementById('variantSelectors').classList.remove('hidden');
            } else {
                document.getElementById('variantSelectors').classList.add('hidden');
            }

            // Update WhatsApp button
            updateWhatsAppButton();
        }

        function renderColorOptions() {
            const container = document.getElementById('colorOptions');
            container.innerHTML = '';

            state.colors.forEach(color => {
                const colorBtn = document.createElement('button');
                colorBtn.className = 'px-3 py-2 rounded-lg border border-gray-700 hover:border-amber-500 text-sm flex items-center gap-2';
                colorBtn.innerHTML = `
                    <div class="w-4 h-4 rounded border" style="background-color: ${color.color_code || '#666'}"></div>
                    <span>${color.color_name}</span>
                `;
                
                colorBtn.addEventListener('click', () => selectColor(color.id, color.color_name));
                
                container.appendChild(colorBtn);
            });

            // Select first color by default
            if (state.colors.length > 0) {
                const firstColor = state.colors[0];
                selectColor(firstColor.id, firstColor.color_name);
            }
        }

        function renderSizeOptions() {
            const container = document.getElementById('sizeOptions');
            container.innerHTML = '';

            if (!state.selectedColor) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Select a color first</p>';
                return;
            }

            // Get sizes for selected color
            const availableSizes = state.sizes.filter(size => size.color_id === state.selectedColor.id);

            if (availableSizes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No sizes available</p>';
                return;
            }

            availableSizes.forEach(size => {
                const stock = size.stock_quantity || 0;
                const sizeBtn = document.createElement('button');
                sizeBtn.className = `px-4 py-2 rounded-lg border text-sm font-medium ${
                    stock === 0 ? 
                    'border-gray-800 text-gray-600 bg-gray-900 cursor-not-allowed' : 
                    'border-gray-700 hover:border-amber-500 hover:bg-amber-900/20'
                }`;
                sizeBtn.textContent = `Size ${size.size_value}`;
                sizeBtn.dataset.sizeId = size.id;
                sizeBtn.dataset.sizeValue = size.size_value;
                sizeBtn.dataset.stock = stock;
                
                if (stock > 0) {
                    sizeBtn.addEventListener('click', () => selectSize(size.id, size.size_value, stock));
                }
                
                container.appendChild(sizeBtn);
            });

            // Select first available size
            const firstAvailableSize = availableSizes.find(size => size.stock_quantity > 0);
            if (firstAvailableSize) {
                selectSize(firstAvailableSize.id, firstAvailableSize.size_value, firstAvailableSize.stock_quantity);
            }
        }

        function selectColor(colorId, colorName) {
            state.selectedColor = { id: colorId, name: colorName };
            
            // Update UI - add selected class to color button
            document.querySelectorAll('#colorOptions button').forEach(btn => {
                btn.classList.remove('bg-amber-900', 'border-amber-500', 'text-white');
            });
            
            // Find and highlight selected color
            document.querySelectorAll('#colorOptions button').forEach(btn => {
                if (btn.textContent.includes(colorName)) {
                    btn.classList.add('bg-amber-900', 'border-amber-500', 'text-white');
                }
            });
            
            // Update size options
            renderSizeOptions();
            updateSelectionSummary();
        }

        function selectSize(sizeId, sizeValue, stock) {
            state.selectedSize = { id: sizeId, value: sizeValue, stock: stock };
            
            // Update UI - add selected class to size button
            document.querySelectorAll('#sizeOptions button').forEach(btn => {
                btn.classList.remove('bg-amber-600', 'border-amber-500', 'text-white');
                if (parseInt(btn.dataset.sizeId) === sizeId) {
                    btn.classList.add('bg-amber-600', 'border-amber-500', 'text-white');
                }
            });
            
            // Update selection summary
            updateSelectionSummary();
            
            // Update quantity max
            const quantityInput = document.getElementById('quantityInput');
            quantityInput.max = stock;
            if (state.quantity > stock) {
                state.quantity = stock;
                quantityInput.value = stock;
            }
        }

        function updateSelectionSummary() {
            const summary = document.getElementById('selectionSummary');
            if (state.selectedColor && state.selectedSize) {
                summary.classList.remove('hidden');
                document.getElementById('selectedVariantText').textContent = 
                    `${state.selectedColor.name} • Size ${state.selectedSize.value}`;
                document.getElementById('availableStockText').textContent = state.selectedSize.stock;
            } else {
                summary.classList.add('hidden');
            }
        }

        function updateWhatsAppButton() {
            if (!state.product) return;
            
            let message = `I'm interested in: ${state.product.name}`;
            if (state.selectedColor) {
                message += ` (Color: ${state.selectedColor.name})`;
            }
            if (state.selectedSize) {
                message += `, Size: ${state.selectedSize.value}`;
            }
            message += ` - ${formatPrice(state.product.price)}`;
            
            document.getElementById('whatsappBtn').href = 
                `https://wa.me/2348139583320?text=${encodeURIComponent(message)}`;
        }

        function addToCart() {
            if (!state.product) return;
            
            // Validate selection for footwear
            const isFootwear = ['mensfootwear', 'womensfootwear'].includes(state.product.category_slug);
            
            if (isFootwear && state.colors.length > 0) {
                if (!state.selectedColor) {
                    showNotification('Please select a color', 'error');
                    return;
                }
                if (!state.selectedSize) {
                    showNotification('Please select a size', 'error');
                    return;
                }
                if (state.selectedSize.stock === 0) {
                    showNotification('This size is out of stock', 'error');
                    return;
                }
                if (state.quantity > state.selectedSize.stock) {
                    showNotification(`Only ${state.selectedSize.stock} units available`, 'error');
                    return;
                }
            }
            
            // Create cart item
            const cartItem = {
                product_id: state.product.id,
                name: state.product.name,
                price: state.product.price,
                image_url: state.product.image_url,
                quantity: state.quantity,
                color_id: state.selectedColor?.id,
                color_name: state.selectedColor?.name,
                size_id: state.selectedSize?.id,
                size_value: state.selectedSize?.value,
                category_slug: state.product.category_slug
            };
            
            // Check if item exists
            const existingIndex = state.cart.findIndex(item => 
                item.product_id === cartItem.product_id && 
                item.color_id === cartItem.color_id && 
                item.size_id === cartItem.size_id
            );
            
            if (existingIndex !== -1) {
                state.cart[existingIndex].quantity += cartItem.quantity;
            } else {
                state.cart.push(cartItem);
            }
            
            // Save to localStorage
            localStorage.setItem('jmpotters_cart', JSON.stringify(state.cart));
            
            // Update UI
            updateHeaderCounts();
            showNotification('Added to cart', 'success');
            
            // Open cart
            openCart();
        }

        function toggleWishlist(product) {
            const existingIndex = state.wishlist.findIndex(item => item.id === product.id);
            const wishlistBtn = document.getElementById('wishlistBtn');
            const countBadge = document.getElementById('wishlistCount');
            
            if (existingIndex !== -1) {
                state.wishlist.splice(existingIndex, 1);
                wishlistBtn.innerHTML = '<i class="far fa-heart text-xl"></i>';
                showNotification('Removed from wishlist', 'info');
            } else {
                state.wishlist.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image_url: product.image_url,
                    slug: product.slug
                });
                wishlistBtn.innerHTML = '<i class="fas fa-heart text-red-400 text-xl"></i>';
                showNotification('Added to wishlist', 'success');
            }
            
            localStorage.setItem('jmpotters_wishlist', JSON.stringify(state.wishlist));
            updateHeaderCounts();
        }

        function updateHeaderCounts() {
            const cartCount = document.getElementById('cartCount');
            const wishlistCount = document.getElementById('wishlistCount');
            
            const totalCartItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            
            if (cartCount) {
                cartCount.textContent = totalCartItems;
                cartCount.classList.toggle('hidden', totalCartItems === 0);
            }
            
            if (wishlistCount) {
                wishlistCount.textContent = state.wishlist.length;
                wishlistCount.classList.toggle('hidden', state.wishlist.length === 0);
            }
        }

        function openCart() {
            document.getElementById('cartPanel').classList.remove('translate-x-full');
            document.getElementById('overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            updateCartPanel();
        }

        function closeCart() {
            document.getElementById('cartPanel').classList.add('translate-x-full');
            document.getElementById('overlay').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function updateCartPanel() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const emptyCart = document.getElementById('emptyCart');
            const whatsappCheckout = document.getElementById('whatsappCheckout');
            
            if (state.cart.length === 0) {
                emptyCart.classList.remove('hidden');
                cartTotal.textContent = '₦0';
                whatsappCheckout.href = '#';
                return;
            }
            
            emptyCart.classList.add('hidden');
            
            let total = 0;
            let itemsHTML = '';
            
            state.cart.forEach((item, index) => {
                const itemTotal = (item.price || 0) * item.quantity;
                total += itemTotal;
                
                itemsHTML += `
                    <div class="flex gap-3 p-3 mb-3 bg-gray-800 rounded-lg">
                        <img src="https://ebuzome.github.io/JMPOTTERS/assets/images/${item.category_slug || 'mensfootwear'}/${item.image_url}" 
                             class="w-16 h-16 object-cover rounded"
                             onerror="this.src='https://via.placeholder.com/100/1e293b/94a3b8?text=Product'">
                        <div class="flex-1">
                            <p class="font-medium text-white text-sm">${item.name}</p>
                            <p class="text-xs text-gray-400">
                                ${item.color_name ? `${item.color_name} • ` : ''}
                                ${item.size_value ? `Size ${item.size_value}` : ''}
                            </p>
                            <div class="flex items-center justify-between mt-2">
                                <div class="flex items-center gap-2">
                                    <button onclick="updateCartItem(${index}, -1)" class="w-6 h-6 bg-gray-700 rounded text-xs">-</button>
                                    <span class="font-semibold">${item.quantity}</span>
                                    <button onclick="updateCartItem(${index}, 1)" class="w-6 h-6 bg-gray-700 rounded text-xs">+</button>
                                </div>
                                <div>
                                    <p class="font-bold text-white text-sm">${formatPrice(itemTotal)}</p>
                                    <button onclick="removeCartItem(${index})" class="text-xs text-red-400 hover:text-red-300">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = itemsHTML;
            cartTotal.textContent = formatPrice(total);
            
            // Update WhatsApp checkout
            let message = "I want to purchase:\n\n";
            state.cart.forEach(item => {
                let itemDesc = item.name;
                if (item.color_name) itemDesc += ` (${item.color_name})`;
                if (item.size_value) itemDesc += ` - Size ${item.size_value}`;
                
                const itemTotal = (item.price || 0) * item.quantity;
                message += `• ${itemDesc}\n  ${item.quantity} × ${formatPrice(item.price)} = ${formatPrice(itemTotal)}\n\n`;
            });
            message += `Total: ${formatPrice(total)}\n\nPlease confirm order & shipping details.`;
            
            whatsappCheckout.href = `https://wa.me/2348139583320?text=${encodeURIComponent(message)}`;
        }

        // Global cart functions
        window.updateCartItem = function(index, change) {
            state.cart[index].quantity += change;
            if (state.cart[index].quantity <= 0) {
                state.cart.splice(index, 1);
            }
            localStorage.setItem('jmpotters_cart', JSON.stringify(state.cart));
            updateCartPanel();
            updateHeaderCounts();
        };

        window.removeCartItem = function(index) {
            state.cart.splice(index, 1);
            localStorage.setItem('jmpotters_cart', JSON.stringify(state.cart));
            updateCartPanel();
            updateHeaderCounts();
            showNotification('Item removed', 'info');
        };

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            
            const colors = {
                success: 'bg-green-900 border-green-700 text-green-100',
                error: 'bg-red-900 border-red-700 text-red-100',
                info: 'bg-blue-900 border-blue-700 text-blue-100'
            };
            
            notification.innerHTML = `
                <div class="${colors[type]} px-4 py-3 rounded-lg border shadow-lg">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                </div>
            `;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function formatPrice(price) {
            if (!price && price !== 0) return '₦0';
            return `₦${parseInt(price).toLocaleString()}`;
        }
    </script>
</body>
</html>
