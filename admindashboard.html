<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JMPOTTERS Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f7ff 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .admin-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header Styles */
        .header {
            background: white;
            border-radius: 20px;
            padding: 28px 36px;
            margin-bottom: 32px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success));
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--gray-900);
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 i {
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary), #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            gap: 16px;
        }

        .status-item {
            padding: 10px 20px;
            background: var(--gray-50);
            border-radius: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .status-item.success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: #10b981;
            color: #065f46;
        }

        .status-item.warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
            color: #92400e;
        }

        .status-item.danger {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #ef4444;
            color: #991b1b;
        }

        /* Main Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(580px, 1fr));
            gap: 28px;
            margin-bottom: 40px;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), transparent);
        }

        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .card-title {
            font-size: 22px;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gray-100);
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 14px;
            font-weight: 700;
        }

        .card-title i {
            color: var(--primary);
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 15px;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--gray-50);
            font-family: 'Inter', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .form-control:disabled {
            background: var(--gray-100);
            color: var(--gray-500);
            cursor: not-allowed;
        }

        /* Button Styles */
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), #1e40af);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Data Lists */
        .data-list {
            max-height: 450px;
            overflow-y: auto;
            margin-top: 24px;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 16px;
            background: var(--gray-50);
        }

        .data-item {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .data-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .data-item:hover {
            background: var(--gray-50);
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .data-info h4 {
            margin-bottom: 8px;
            color: var(--gray-900);
            font-size: 17px;
            font-weight: 600;
        }

        .data-info p {
            font-size: 14px;
            color: var(--gray-600);
        }

        .data-actions {
            display: flex;
            gap: 10px;
        }

        /* Color Swatch */
        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid var(--gray-300);
            display: inline-block;
            vertical-align: middle;
            margin-right: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        /* Stock Badges */
        .stock-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .stock-in {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
        }

        .stock-low {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .stock-out {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px 40px;
            color: var(--gray-600);
        }

        .loading i {
            font-size: 40px;
            margin-bottom: 20px;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            margin-top: 16px;
            color: var(--gray-500);
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
            width: 350px;
        }

        .message {
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message.success {
            background: white;
            border-left-color: var(--success);
            color: var(--gray-800);
        }

        .message.error {
            background: white;
            border-left-color: var(--danger);
            color: var(--gray-800);
        }

        .message.warning {
            background: white;
            border-left-color: var(--warning);
            color: var(--gray-800);
        }

        .message.info {
            background: white;
            border-left-color: var(--info);
            color: var(--gray-800);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
            animation: modalSlideIn 0.4s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .modal-header h3 {
            font-size: 26px;
            color: var(--gray-900);
            font-weight: 700;
        }

        .close-btn {
            background: var(--gray-100);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray-600);
            font-size: 24px;
        }

        .close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }

        .action-card {
            background: linear-gradient(135deg, var(--primary), #60a5fa);
            color: white;
            padding: 24px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.3);
        }

        .action-card i {
            font-size: 32px;
            margin-bottom: 16px;
        }

        .action-card span {
            font-size: 16px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid #bae6fd;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border-color: #fde68a;
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border-color: #fecaca;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-color: #a7f3d0;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-card.warning .stat-number {
            color: var(--warning);
        }

        .stat-card.danger .stat-number {
            color: var(--danger);
        }

        .stat-card.success .stat-number {
            color: var(--success);
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 24px;
        }

        .search-bar input {
            width: 100%;
            padding: 18px 24px 18px 56px;
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            font-size: 16px;
            background: var(--gray-50);
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .search-bar i {
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 18px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 16px;
            }
            
            .header {
                padding: 24px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .status-bar {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .card {
                padding: 24px;
            }
            
            .modal {
                padding: 24px;
                width: 95%;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
        }

        .badge-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .badge-danger {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-tachometer-alt"></i> JMPOTTERS Admin Dashboard</h1>
                <div class="status-bar">
                    <div class="status-item" id="connectionStatus">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <span>Connecting to Supabase...</span>
                    </div>
                    <div class="status-item success" id="productCountBadge">
                        <i class="fas fa-box"></i>
                        <span id="productCount">0</span> Products
                    </div>
                    <div class="status-item warning" id="variantCountBadge">
                        <i class="fas fa-layer-group"></i>
                        <span id="variantCount">0</span> Variants
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="message-container" id="messageContainer"></div>

        <!-- Quick Actions -->
        <div class="card">
            <h2 class="card-title"><i class="fas fa-bolt"></i> Quick Actions</h2>
            <div class="quick-actions">
                <button class="action-card" onclick="refreshAllData()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh Data</span>
                </button>
                <button class="action-card" onclick="showAddProductModal()" style="background: linear-gradient(135deg, var(--success), #059669);">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add New Product</span>
                </button>
                <button class="action-card" onclick="exportToCSV()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <i class="fas fa-download"></i>
                    <span>Export Data</span>
                </button>
                <button class="action-card" onclick="showLowStockReport()" style="background: linear-gradient(135deg, var(--warning), #d97706);">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Low Stock Alert</span>
                </button>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Product Management -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-boxes"></i> Product Management</h2>
                
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="productSearch" placeholder="Search products..." onkeyup="filterProducts()">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Category Filter:</label>
                        <select id="categoryFilter" class="form-control" onchange="filterProductsByCategory()">
                            <option value="">All Categories</option>
                            <!-- Categories will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status Filter:</label>
                        <select id="statusFilter" class="form-control" onchange="filterProducts()">
                            <option value="">All Status</option>
                            <option value="active">Active Only</option>
                            <option value="inactive">Inactive Only</option>
                        </select>
                    </div>
                </div>
                
                <div class="data-list" id="productsList">
                    <div class="loading">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <div class="loading-text">Loading products...</div>
                    </div>
                </div>
            </div>

            <!-- Variant & Stock Management -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-cubes"></i> Variant & Stock Management</h2>
                
                <div class="form-group">
                    <label>Select Product for Variants:</label>
                    <select id="variantProductSelect" class="form-control" onchange="loadVariantsForProduct()">
                        <option value="">Select a product...</option>
                        <!-- Products will be populated by JavaScript -->
                    </select>
                </div>
                
                <div id="variantForm" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Color Name:</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="text" id="variantColorName" class="form-control" placeholder="e.g., Midnight Black">
                                <input type="color" id="variantColorHex" value="#000000" style="width: 60px; height: 40px; border-radius: 8px; border: 2px solid var(--gray-300);">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Size:</label>
                            <select id="variantSize" class="form-control">
                                <option value="">Select size...</option>
                                <option value="36">36</option>
                                <option value="37">37</option>
                                <option value="38">38</option>
                                <option value="39">39</option>
                                <option value="40">40</option>
                                <option value="41">41</option>
                                <option value="42">42</option>
                                <option value="43">43</option>
                                <option value="44">44</option>
                                <option value="45">45</option>
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="XXL">XXL</option>
                                <option value="One Size">One Size</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Stock Quantity:</label>
                        <input type="number" id="variantStock" class="form-control" min="0" value="10" step="1">
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-primary" onclick="addOrUpdateVariant()">
                            <i class="fas fa-save"></i> Save Variant
                        </button>
                        <button class="btn" onclick="resetVariantForm()" style="background: var(--gray-100); color: var(--gray-700);">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div id="variantsList" class="data-list" style="margin-top: 24px;">
                    <div class="loading">Select a product to view variants</div>
                </div>
            </div>

            <!-- Statistics & Analytics -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Statistics & Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProductsStat">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="lowStockCount">0</div>
                        <div class="stat-label">Low Stock</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number" id="outOfStockCount">0</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="totalVariantsStat">0</div>
                        <div class="stat-label">Total Variants</div>
                    </div>
                </div>
                
                <div style="margin-top: 32px;">
                    <h4 style="margin-bottom: 20px; color: var(--gray-700);">Category Distribution</h4>
                    <div id="categoryChart" style="height: 200px; background: var(--gray-50); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <div class="loading">
                            <i class="fas fa-circle-notch fa-spin"></i>
                            <div class="loading-text">Loading chart...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-history"></i> Recent Activity</h2>
                <div id="activityFeed" class="data-list">
                    <div class="loading">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <div class="loading-text">Loading activity...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal-overlay" id="addProductModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Add New Product</h3>
                <button class="close-btn" onclick="closeAddProductModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Product Name:</label>
                <input type="text" id="newProductName" class="form-control" placeholder="Enter product name">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Price (‚Ç¶):</label>
                    <input type="number" id="newProductPrice" class="form-control" min="0" step="100" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="newProductCategory" class="form-control">
                        <option value="">Select category...</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Description:</label>
                <textarea id="newProductDescription" class="form-control" rows="3" placeholder="Enter product description"></textarea>
            </div>
            
            <div class="form-group">
                <label>Image URL:</label>
                <input type="text" id="newProductImageUrl" class="form-control" placeholder="image.jpg">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Initial Stock:</label>
                    <input type="number" id="newProductStock" class="form-control" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="newProductStatus" class="form-control">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 32px;">
                <button class="btn btn-success" onclick="createNewProduct()" style="flex: 1;">
                    <i class="fas fa-check"></i> Create Product
                </button>
                <button class="btn" onclick="closeAddProductModal()" style="flex: 1; background: var(--gray-100); color: var(--gray-700);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Stock Update Modal -->
    <div class="modal-overlay" id="stockUpdateModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Update Stock</h3>
                <button class="close-btn" onclick="closeStockModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Variant:</label>
                <div id="modalVariantInfo" style="background: var(--gray-50); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    Loading variant info...
                </div>
            </div>
            
            <div class="form-group">
                <label>New Stock Quantity:</label>
                <input type="number" id="modalStockQuantity" class="form-control" min="0" value="0">
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 32px;">
                <button class="btn btn-primary" onclick="updateVariantStock()" style="flex: 1;">
                    <i class="fas fa-save"></i> Update Stock
                </button>
                <button class="btn" onclick="closeStockModal()" style="flex: 1; background: var(--gray-100); color: var(--gray-700);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Low Stock Report Modal -->
    <div class="modal-overlay" id="lowStockModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Low Stock Report</h3>
                <button class="close-btn" onclick="closeLowStockModal()">&times;</button>
            </div>
            
            <div id="lowStockContent" style="max-height: 400px; overflow-y: auto;">
                <div class="loading">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <div class="loading-text">Generating report...</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 32px;">
                <button class="btn" onclick="closeLowStockModal()" style="flex: 1; background: var(--gray-100); color: var(--gray-700);">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // ====================
        // SUPABASE CONFIGURATION
        // ====================
        const SUPABASE_URL = 'https://tmpggeeuwdvlngvfncaa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcGdnZWV1d2R2bG5ndmZuY2FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTc0MDYsImV4cCI6MjA3Nzc3MzQwNn0.EKzkKWmzYMvQuN11vEjRTDHrUbh6dYXk7clxVsYQ0b4';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // State management
        let allProducts = [];
        let allCategories = [];
        let allVariants = [];
        let currentEditingVariantId = null;
        let editingVariant = null;
        
        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function showMessage(text, type = 'success', duration = 5000) {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'exclamation-circle' : 
                                  type === 'warning' ? 'exclamation-triangle' : 
                                  'info-circle'}"></i>
                <span>${text}</span>
            `;
            container.appendChild(message);
            
            setTimeout(() => {
                message.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => message.remove(), 300);
            }, duration);
        }
        
        function formatPrice(price) {
            return `‚Ç¶${parseInt(price || 0).toLocaleString()}`;
        }
        
        // ====================
        // CONNECTION & INITIALIZATION
        // ====================
        async function initializeDashboard() {
            console.log('üöÄ Initializing JMPOTTERS Admin Dashboard...');
            
            // Test connection
            const connected = await testConnection();
            if (!connected) return;
            
            // Load all data
            await loadCategories();
            await loadProducts();
            await updateStatistics();
            await loadActivityFeed();
            
            console.log('‚úÖ Admin dashboard initialized successfully');
            showMessage('Admin dashboard loaded successfully!', 'success');
        }
        
        async function testConnection() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                document.getElementById('connectionStatus').innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Connected to Supabase</span>
                `;
                document.getElementById('connectionStatus').classList.add('success');
                
                return true;
            } catch (error) {
                console.error('‚ùå Connection error:', error);
                document.getElementById('connectionStatus').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Connection Failed: ${error.message}</span>
                `;
                document.getElementById('connectionStatus').classList.remove('success');
                document.getElementById('connectionStatus').classList.add('danger');
                
                showMessage(`Failed to connect to database: ${error.message}`, 'error');
                return false;
            }
        }
        
        // ====================
        // CATEGORY MANAGEMENT
        // ====================
        async function loadCategories() {
            try {
                const { data: categories, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                allCategories = categories;
                
                // Populate category dropdowns
                const categoryFilter = document.getElementById('categoryFilter');
                const newProductCategory = document.getElementById('newProductCategory');
                
                if (categoryFilter) {
                    categoryFilter.innerHTML = '<option value="">All Categories</option>' +
                        categories.map(cat => `<option value="${cat.slug}">${cat.name}</option>`).join('');
                }
                
                if (newProductCategory) {
                    newProductCategory.innerHTML = '<option value="">Select category...</option>' +
                        categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                }
                
                // Update category chart
                updateCategoryChart();
                
                return categories;
            } catch (error) {
                console.error('Error loading categories:', error);
                showMessage('Failed to load categories: ' + error.message, 'error');
                return [];
            }
        }
        
        // ====================
        // PRODUCT MANAGEMENT
        // ====================
        async function loadProducts() {
            try {
                // Show loading state
                document.getElementById('productsList').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <div class="loading-text">Loading products...</div>
                    </div>
                `;
                
                // Load products with their categories
                const { data: products, error } = await supabase
                    .from('products')
                    .select(`
                        *,
                        categories (
                            id,
                            name,
                            slug
                        )
                    `)
                    .order('name');
                
                if (error) throw error;
                
                allProducts = products || [];
                
                // Update UI
                updateProductList(products);
                updateProductDropdowns(products);
                updateStatistics();
                
                console.log(`‚úÖ Loaded ${products.length} products`);
                return products;
                
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsList').innerHTML = `
                    <div class="error" style="padding: 40px; text-align: center; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>Failed to load products</h3>
                        <p>${error.message}</p>
                        <button onclick="loadProducts()" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
                showMessage('Failed to load products: ' + error.message, 'error');
                return [];
            }
        }
        
        function updateProductList(products) {
            const container = document.getElementById('productsList');
            if (!container) return;
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-500);">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>No products found</h3>
                        <p>Add your first product to get started</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            products.forEach(product => {
                const categoryName = product.categories?.name || 'Uncategorized';
                const isActive = product.is_active;
                
                html += `
                    <div class="data-item" data-product-id="${product.id}">
                        <div class="data-info">
                            <h4>
                                ${product.name}
                                <span class="badge ${isActive ? 'badge-success' : 'badge-danger'}" style="margin-left: 8px;">
                                    ${isActive ? 'Active' : 'Inactive'}
                                </span>
                            </h4>
                            <p>
                                <strong>Category:</strong> ${categoryName} | 
                                <strong>Price:</strong> ${formatPrice(product.price)} | 
                                <strong>ID:</strong> ${product.id}
                            </p>
                            <p style="color: var(--gray-500); margin-top: 8px; font-size: 13px;">
                                ${product.description?.substring(0, 100) || 'No description'}...
                            </p>
                        </div>
                        <div class="data-actions">
                            <button class="btn btn-sm" onclick="editProduct(${product.id})" style="background: var(--gray-100); color: var(--gray-700);">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm" onclick="deleteProduct(${product.id})" style="background: var(--danger); color: white;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateProductDropdowns(products) {
            const variantProductSelect = document.getElementById('variantProductSelect');
            if (!variantProductSelect) return;
            
            variantProductSelect.innerHTML = '<option value="">Select a product...</option>' +
                products.map(p => `
                    <option value="${p.id}">
                        ${p.name} (${p.categories?.name || 'No Category'})
                    </option>
                `).join('');
        }
        
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredProducts = allProducts;
            
            // Apply search filter
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply category filter
            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => 
                    p.categories?.slug === categoryFilter
                );
            }
            
            // Apply status filter
            if (statusFilter === 'active') {
                filteredProducts = filteredProducts.filter(p => p.is_active);
            } else if (statusFilter === 'inactive') {
                filteredProducts = filteredProducts.filter(p => !p.is_active);
            }
            
            updateProductList(filteredProducts);
        }
        
        function filterProductsByCategory() {
            filterProducts();
        }
        
        // ====================
        // PRODUCT CRUD OPERATIONS
        // ====================
        async function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            // For now, we'll show a simple edit form
            const newName = prompt('Enter new product name:', product.name);
            if (!newName || newName === product.name) return;
            
            const newPrice = prompt('Enter new price:', product.price);
            if (!newPrice) return;
            
            try {
                const { error } = await supabase
                    .from('products')
                    .update({
                        name: newName,
                        price: parseFloat(newPrice),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);
                
                if (error) throw error;
                
                showMessage('‚úÖ Product updated successfully!');
                await loadProducts();
                
            } catch (error) {
                showMessage('‚ùå Error updating product: ' + error.message, 'error');
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This will also delete all its variants, colors, and sizes!')) {
                return;
            }
            
            try {
                // Delete related variants first
                const { error: sizesError } = await supabase
                    .from('product_sizes')
                    .delete()
                    .eq('product_id', productId);
                
                if (sizesError) throw sizesError;
                
                // Delete colors
                const { error: colorsError } = await supabase
                    .from('product_colors')
                    .delete()
                    .eq('product_id', productId);
                
                if (colorsError) throw colorsError;
                
                // Delete the product
                const { error: productError } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (productError) throw productError;
                
                showMessage('‚úÖ Product and all variants deleted!');
                await loadProducts();
                await loadVariantsForProduct(); // Refresh variant list
                
            } catch (error) {
                showMessage('‚ùå Error deleting product: ' + error.message, 'error');
            }
        }
        
        // ====================
        // VARIANT MANAGEMENT
        // ====================
        async function loadVariantsForProduct() {
            const productId = document.getElementById('variantProductSelect').value;
            
            if (!productId) {
                document.getElementById('variantForm').style.display = 'none';
                document.getElementById('variantsList').innerHTML = `
                    <div class="loading">Select a product to view variants</div>
                `;
                return;
            }
            
            try {
                document.getElementById('variantsList').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <div class="loading-text">Loading variants...</div>
                    </div>
                `;
                
                document.getElementById('variantForm').style.display = 'block';
                
                // Load variants with color information
                const { data: variants, error } = await supabase
                    .from('product_sizes')
                    .select(`
                        *,
                        product_colors (
                            color_name,
                            color_code
                        )
                    `)
                    .eq('product_id', productId)
                    .order('size_value');
                
                if (error) throw error;
                
                allVariants = variants || [];
                
                // Display variants
                if (variants.length === 0) {
                    document.getElementById('variantsList').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
                            <i class="fas fa-cubes" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3>No variants found</h3>
                            <p>Add your first variant to get started</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                variants.forEach(variant => {
                    const color = variant.product_colors;
                    const stock = variant.stock_quantity;
                    const stockClass = stock === 0 ? 'stock-out' : 
                                      stock < 5 ? 'stock-low' : 'stock-in';
                    const stockText = stock === 0 ? 'Out of stock' : 
                                     stock < 5 ? `${stock} left` : 
                                     'In stock';
                    
                    html += `
                        <div class="data-item">
                            <div class="data-info">
                                <h4>
                                    <span class="color-swatch" style="background: ${color?.color_code || '#ccc'}"></span>
                                    ${color?.color_name || 'No Color'} - Size ${variant.size_value}
                                </h4>
                                <p>
                                    <strong>Variant ID:</strong> ${variant.id} | 
                                    <strong>Stock:</strong> 
                                    <span class="stock-badge ${stockClass}">${stockText}</span>
                                </p>
                            </div>
                            <div class="data-actions">
                                <button class="btn btn-sm" onclick="editStock(${variant.id})" style="background: var(--gray-100); color: var(--gray-700);">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteVariant(${variant.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('variantsList').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading variants:', error);
                document.getElementById('variantsList').innerHTML = `
                    <div class="error" style="padding: 40px; text-align: center; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>Failed to load variants</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function addOrUpdateVariant() {
            const productId = document.getElementById('variantProductSelect').value;
            const colorName = document.getElementById('variantColorName').value.trim();
            const colorHex = document.getElementById('variantColorHex').value;
            const sizeValue = document.getElementById('variantSize').value;
            const stockQuantity = parseInt(document.getElementById('variantStock').value);
            
            if (!productId || !colorName || !sizeValue) {
                showMessage('Please fill in all required fields', 'warning');
                return;
            }
            
            if (isNaN(stockQuantity) || stockQuantity < 0) {
                showMessage('Please enter a valid stock quantity', 'warning');
                return;
            }
            
            try {
                // Step 1: Find or create color
                let colorId;
                const { data: existingColor, error: colorError } = await supabase
                    .from('product_colors')
                    .select('id')
                    .eq('product_id', productId)
                    .eq('color_name', colorName)
                    .maybeSingle();
                
                if (colorError && colorError.code !== 'PGRST116') throw colorError;
                
                if (existingColor) {
                    colorId = existingColor.id;
                } else {
                    // Create new color
                    const { data: newColor, error: createColorError } = await supabase
                        .from('product_colors')
                        .insert([{
                            product_id: productId,
                            color_name: colorName,
                            color_code: colorHex,
                            is_default: false,
                            sort_order: 0
                        }])
                        .select()
                        .single();
                    
                    if (createColorError) throw createColorError;
                    colorId = newColor.id;
                }
                
                // Step 2: Check if variant exists
                const { data: existingVariant, error: variantError } = await supabase
                    .from('product_sizes')
                    .select('*')
                    .eq('product_id', productId)
                    .eq('color_id', colorId)
                    .eq('size_value', sizeValue)
                    .maybeSingle();
                
                if (variantError && variantError.code !== 'PGRST116') throw variantError;
                
                if (existingVariant) {
                    // Update existing variant
                    const { error: updateError } = await supabase
                        .from('product_sizes')
                        .update({
                            stock_quantity: stockQuantity,
                            is_available: stockQuantity > 0,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingVariant.id);
                    
                    if (updateError) throw updateError;
                    showMessage('‚úÖ Variant updated successfully!');
                } else {
                    // Create new variant
                    const { error: createError } = await supabase
                        .from('product_sizes')
                        .insert([{
                            product_id: productId,
                            color_id: colorId,
                            size_value: sizeValue,
                            stock_quantity: stockQuantity,
                            is_available: stockQuantity > 0
                        }]);
                    
                    if (createError) throw createError;
                    showMessage('‚úÖ Variant created successfully!');
                }
                
                // Reset form
                resetVariantForm();
                
                // Refresh variant list
                await loadVariantsForProduct();
                await updateStatistics();
                
            } catch (error) {
                console.error('Error saving variant:', error);
                showMessage('‚ùå Error saving variant: ' + error.message, 'error');
            }
        }
        
        function resetVariantForm() {
            document.getElementById('variantColorName').value = '';
            document.getElementById('variantColorHex').value = '#000000';
            document.getElementById('variantSize').value = '';
            document.getElementById('variantStock').value = '10';
        }
        
        // ====================
        // STOCK MANAGEMENT
        // ====================
        async function editStock(variantId) {
            try {
                // Get variant details
                const { data: variant, error } = await supabase
                    .from('product_sizes')
                    .select(`
                        *,
                        product_colors (
                            color_name,
                            color_code
                        ),
                        products (
                            name
                        )
                    `)
                    .eq('id', variantId)
                    .single();
                
                if (error) throw error;
                
                editingVariant = variant;
                currentEditingVariantId = variantId;
                
                // Update modal content
                document.getElementById('modalVariantInfo').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span class="color-swatch" style="background: ${variant.product_colors?.color_code || '#ccc'}"></span>
                        <div>
                            <h4 style="margin: 0; color: var(--gray-900);">${variant.products?.name || 'Unknown Product'}</h4>
                            <p style="margin: 4px 0 0 0; color: var(--gray-600);">
                                ${variant.product_colors?.color_name || 'No Color'} - Size ${variant.size_value}
                            </p>
                            <p style="margin: 4px 0 0 0; color: var(--gray-500); font-size: 13px;">
                                Current stock: <strong>${variant.stock_quantity}</strong>
                            </p>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalStockQuantity').value = variant.stock_quantity;
                
                // Show modal
                document.getElementById('stockUpdateModal').style.display = 'flex';
                
            } catch (error) {
                showMessage('Error loading variant details: ' + error.message, 'error');
            }
        }
        
        async function updateVariantStock() {
            if (!currentEditingVariantId || !editingVariant) return;
            
            const newStock = parseInt(document.getElementById('modalStockQuantity').value);
            
            if (isNaN(newStock) || newStock < 0) {
                showMessage('Please enter a valid stock quantity', 'warning');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('product_sizes')
                    .update({
                        stock_quantity: newStock,
                        is_available: newStock > 0,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentEditingVariantId);
                
                if (error) throw error;
                
                showMessage('‚úÖ Stock updated successfully!');
                closeStockModal();
                await loadVariantsForProduct();
                await updateStatistics();
                
            } catch (error) {
                showMessage('‚ùå Error updating stock: ' + error.message, 'error');
            }
        }
        
        async function deleteVariant(variantId) {
            if (!confirm('Are you sure you want to delete this variant?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('product_sizes')
                    .delete()
                    .eq('id', variantId);
                
                if (error) throw error;
                
                showMessage('‚úÖ Variant deleted!');
                await loadVariantsForProduct();
                await updateStatistics();
                
            } catch (error) {
                showMessage('‚ùå Error deleting variant: ' + error.message, 'error');
            }
        }
        
        // ====================
        // NEW PRODUCT FUNCTIONALITY
        // ====================
        function showAddProductModal() {
            document.getElementById('addProductModal').style.display = 'flex';
        }
        
        function closeAddProductModal() {
            document.getElementById('addProductModal').style.display = 'none';
        }
        
        async function createNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const categoryId = parseInt(document.getElementById('newProductCategory').value);
            const description = document.getElementById('newProductDescription').value.trim();
            const imageUrl = document.getElementById('newProductImageUrl').value.trim();
            const stock = parseInt(document.getElementById('newProductStock').value);
            const isActive = document.getElementById('newProductStatus').value === 'true';
            
            // Validation
            if (!name) {
                showMessage('Product name is required', 'warning');
                return;
            }
            
            if (!categoryId) {
                showMessage('Please select a category', 'warning');
                return;
            }
            
            if (!price || price < 0) {
                showMessage('Please enter a valid price', 'warning');
                return;
            }
            
            try {
                const { data: product, error } = await supabase
                    .from('products')
                    .insert([{
                        name: name,
                        price: price,
                        description: description || null,
                        image_url: imageUrl || null,
                        category_id: categoryId,
                        stock: stock || 0,
                        is_active: isActive
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showMessage('‚úÖ Product created successfully!');
                closeAddProductModal();
                
                // Clear form
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                document.getElementById('newProductCategory').value = '';
                document.getElementById('newProductDescription').value = '';
                document.getElementById('newProductImageUrl').value = '';
                document.getElementById('newProductStock').value = '0';
                document.getElementById('newProductStatus').value = 'true';
                
                // Refresh data
                await loadProducts();
                
            } catch (error) {
                console.error('Error creating product:', error);
                showMessage('‚ùå Error creating product: ' + error.message, 'error');
            }
        }
        
        // ====================
        // STATISTICS & ANALYTICS
        // ====================
        async function updateStatistics() {
            try {
                // Get total variants count
                const { data: variants, error: variantsError } = await supabase
                    .from('product_sizes')
                    .select('stock_quantity', { count: 'exact', head: true });
                
                if (variantsError) throw variantsError;
                
                // Calculate low stock and out of stock
                let lowStockCount = 0;
                let outOfStockCount = 0;
                
                allVariants.forEach(variant => {
                    if (variant.stock_quantity === 0) {
                        outOfStockCount++;
                    } else if (variant.stock_quantity < 5) {
                        lowStockCount++;
                    }
                });
                
                // Update UI
                document.getElementById('totalProductsStat').textContent = allProducts.length;
                document.getElementById('totalVariantsStat').textContent = variants.count || 0;
                document.getElementById('lowStockCount').textContent = lowStockCount;
                document.getElementById('outOfStockCount').textContent = outOfStockCount;
                
                // Update header badges
                document.getElementById('productCount').textContent = allProducts.length;
                document.getElementById('variantCount').textContent = variants.count || 0;
                
                // Update badge colors based on stock status
                const variantBadge = document.getElementById('variantCountBadge');
                if (outOfStockCount > 0) {
                    variantBadge.className = 'status-item danger';
                } else if (lowStockCount > 0) {
                    variantBadge.className = 'status-item warning';
                } else {
                    variantBadge.className = 'status-item success';
                }
                
            } catch (error) {
                console.error('Error updating statistics:', error);
            }
        }
        
        function updateCategoryChart() {
            const chartContainer = document.getElementById('categoryChart');
            if (!chartContainer) return;
            
            // Group products by category
            const categoryCounts = {};
            allProducts.forEach(product => {
                const categoryName = product.categories?.name || 'Uncategorized';
                categoryCounts[categoryName] = (categoryCounts[categoryName] || 0) + 1;
            });
            
            if (Object.keys(categoryCounts).length === 0) {
                chartContainer.innerHTML = `
                    <div style="text-align: center; color: var(--gray-500);">
                        <i class="fas fa-chart-pie" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No category data available</p>
                    </div>
                `;
                return;
            }
            
            // Create simple chart with colored bars
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            let chartHTML = '<div style="width: 100%; padding: 20px;">';
            
            Object.entries(categoryCounts).forEach(([category, count], index) => {
                const percentage = (count / allProducts.length) * 100;
                chartHTML += `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 14px; color: var(--gray-700);">${category}</span>
                            <span style="font-size: 14px; font-weight: 600; color: var(--gray-800);">${count}</span>
                        </div>
                        <div style="height: 10px; background: var(--gray-200); border-radius: 5px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${colors[index % colors.length]}; border-radius: 5px;"></div>
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        // ====================
        // ACTIVITY FEED
        // ====================
        async function loadActivityFeed() {
            try {
                // Get recent variants updates
                const { data: recentVariants, error } = await supabase
                    .from('product_sizes')
                    .select(`
                        updated_at,
                        stock_quantity,
                        size_value,
                        product_colors (
                            color_name
                        ),
                        products (
                            name
                        )
                    `)
                    .order('updated_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const activityContainer = document.getElementById('activityFeed');
                if (!activityContainer) return;
                
                if (!recentVariants || recentVariants.length === 0) {
                    activityContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray-500);">
                            <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                recentVariants.forEach(activity => {
                    const productName = activity.products?.name || 'Unknown Product';
                    const colorName = activity.product_colors?.color_name || 'Unknown Color';
                    const date = new Date(activity.updated_at);
                    const timeAgo = getTimeAgo(date);
                    
                    html += `
                        <div class="data-item">
                            <div class="data-info">
                                <h4 style="font-size: 15px;">${productName}</h4>
                                <p style="color: var(--gray-600); font-size: 13px;">
                                    ${colorName} - Size ${activity.size_value} ‚Ä¢ Stock: ${activity.stock_quantity}
                                </p>
                                <p style="color: var(--gray-500); font-size: 12px; margin-top: 4px;">
                                    <i class="far fa-clock"></i> ${timeAgo}
                                </p>
                            </div>
                        </div>
                    `;
                });
                
                activityContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading activity feed:', error);
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
        
        // ====================
        // LOW STOCK REPORT
        // ====================
        async function showLowStockReport() {
            try {
                // Get all variants with low stock
                const { data: lowStockVariants, error } = await supabase
                    .from('product_sizes')
                    .select(`
                        stock_quantity,
                        size_value,
                        product_colors (
                            color_name,
                            color_code
                        ),
                        products (
                            name,
                            categories (
                                name
                            )
                        )
                    `)
                    .lt('stock_quantity', 10)
                    .order('stock_quantity', { ascending: true });
                
                if (error) throw error;
                
                const modalContent = document.getElementById('lowStockContent');
                if (!modalContent) return;
                
                if (!lowStockVariants || lowStockVariants.length === 0) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--success);">
                            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3>All Good!</h3>
                            <p>No low stock items found. All variants have sufficient stock.</p>
                        </div>
                    `;
                } else {
                    let html = `
                        <div style="background: var(--gray-50); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="margin: 0; color: var(--gray-900);">
                                    <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                                    Low Stock Items (${lowStockVariants.length})
                                </h4>
                                <span style="color: var(--gray-600); font-size: 14px;">
                                    Stock < 10 units
                                </span>
                            </div>
                        </div>
                    `;
                    
                    lowStockVariants.forEach(variant => {
                        const stock = variant.stock_quantity;
                        const stockClass = stock === 0 ? 'stock-out' : 
                                          stock < 5 ? 'stock-low' : 'stock-warning';
                        const stockText = stock === 0 ? 'Out of stock' : 
                                         stock < 5 ? `${stock} left (Critical)` : 
                                         `${stock} left (Low)`;
                        
                        html += `
                            <div class="data-item" style="margin-bottom: 12px;">
                                <div class="data-info">
                                    <h4 style="font-size: 15px;">
                                        ${variant.products?.name || 'Unknown Product'}
                                    </h4>
                                    <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0;">
                                        <span class="color-swatch" style="background: ${variant.product_colors?.color_code || '#ccc'}"></span>
                                        ${variant.product_colors?.color_name || 'Unknown Color'} - Size ${variant.size_value}
                                    </p>
                                    <p style="color: var(--gray-500); font-size: 12px;">
                                        Category: ${variant.products?.categories?.name || 'Unknown'}
                                    </p>
                                </div>
                                <div>
                                    <span class="stock-badge ${stockClass}">${stockText}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    modalContent.innerHTML = html;
                }
                
                // Show modal
                document.getElementById('lowStockModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading low stock report:', error);
                showMessage('Error loading low stock report: ' + error.message, 'error');
            }
        }
        
        function closeLowStockModal() {
            document.getElementById('lowStockModal').style.display = 'none';
        }
        
        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function closeStockModal() {
            document.getElementById('stockUpdateModal').style.display = 'none';
            currentEditingVariantId = null;
            editingVariant = null;
        }
        
        async function refreshAllData() {
            showMessage('Refreshing all data...', 'info');
            
            try {
                await Promise.all([
                    loadCategories(),
                    loadProducts(),
                    loadVariantsForProduct()
                ]);
                
                await updateStatistics();
                await loadActivityFeed();
                
                showMessage('‚úÖ All data refreshed successfully!', 'success');
            } catch (error) {
                showMessage('‚ùå Error refreshing data: ' + error.message, 'error');
            }
        }
        
        function exportToCSV() {
            if (allProducts.length === 0) {
                showMessage('No data to export', 'warning');
                return;
            }
            
            let csv = 'Product ID,Product Name,Category,Price,Stock,Status,Description\n';
            
            allProducts.forEach(product => {
                const categoryName = product.categories?.name || 'Uncategorized';
                const status = product.is_active ? 'Active' : 'Inactive';
                const description = (product.description || '').replace(/"/g, '""');
                
                csv += `"${product.id}","${product.name}","${categoryName}","${product.price}","${product.stock}","${status}","${description}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `jmpotters-products-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‚úÖ CSV exported successfully!', 'success');
        }
        
        // ====================
        // INITIALIZE DASHBOARD
        // ====================
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
            }
        });
        
        // Handle escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });
        
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showMessage(`JavaScript Error: ${event.message}`, 'error');
        });
    </script>
</body>
</html>
